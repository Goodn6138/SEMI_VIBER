<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Get Early Access</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="container">
      <section class="card">
        <h1>Get Early Access</h1>
        <p class="subtitle">Sign up and complete a secure checkout to reserve your spot.</p>

        <form id="signup-form" class="form" novalidate>
          <div class="field">
            <label for="name">Full name</label>
            <input id="name" name="name" type="text" placeholder="Ada Lovelace" required />
            <small class="error" id="name-error"></small>
          </div>
          <div class="field">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" placeholder="you@example.com" required />
            <small class="error" id="email-error"></small>
          </div>

          <button id="submit" type="submit">Continue to secure payment</button>
          <p class="fineprint">Powered by <span class="stripe">Stripe</span>. We never see your card details.</p>
          <div class="notice" id="form-notice" hidden></div>
        </form>
      </section>
    </main>

    <script>
      const form = document.getElementById('signup-form');
      const submitBtn = document.getElementById('submit');
      const notice = document.getElementById('form-notice');

      function setNotice(text, kind = 'info') {
        notice.textContent = text;
        notice.dataset.kind = kind;
        notice.hidden = !text;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setNotice('');

        const name = document.getElementById('name').value.trim();
        const email = document.getElementById('email').value.trim();

        let hasError = false;
        const nameError = document.getElementById('name-error');
        const emailError = document.getElementById('email-error');
        nameError.textContent = '';
        emailError.textContent = '';

        if (!name) {
          nameError.textContent = 'Please enter your full name';
          hasError = true;
        }
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          emailError.textContent = 'Please enter a valid email address';
          hasError = true;
        }
        if (hasError) return;

        submitBtn.disabled = true;
        submitBtn.textContent = 'Redirectingâ€¦';

        try {
          const res = await fetch('/api/create-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email })
          });
          if (!res.ok) throw new Error('Failed to create session');
          const data = await res.json();
          if (!data.url) throw new Error('No checkout URL returned');
          window.location.href = data.url;
        } catch (err) {
          setNotice('Something went wrong. Please try again.', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Continue to secure payment';
        }
      });
    </script>
  </body>
</html>
